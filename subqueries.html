<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Diane Horton" />
  <title>8 Subqueries</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.line-block{white-space: pre-line;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span. { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://www.teach.cs.toronto.edu/~csc343h/fall/tufte.css">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header>
<h1 class="title">8 Subqueries</h1>
<p class="author">Diane Horton</p>
</header>
<section class="level1">
<p>The syntax of relational algebra was so simple and elegant that is was easy to specify where subqueries could go. SQL requires a bit more thought. Here’s we’ll work through each of the valid locations for a subquery.</p>
<h2 id="subqueries-with-set-operations">Subqueries with set operations</h2>
<p>We’ve already seen that set operations involve subqueries. For example, this <code>INTERSECT</code> query has two operands, each of which is a subquery:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb1-1" title="1">    csc343h<span class="op">-</span>prof<span class="op">=&gt;</span> <span class="co">-- Recall that the round brackets are required.</span></a>
<a class="sourceLine" id="cb1-2" title="2">    csc343h<span class="op">-</span>prof<span class="op">=&gt;</span> (<span class="kw">SELECT</span> sid <span class="kw">FROM</span> Took <span class="kw">WHERE</span> grade <span class="op">&gt;</span> <span class="dv">95</span>)</a>
<a class="sourceLine" id="cb1-3" title="3">    csc343h<span class="op">-</span>prof<span class="op">-&gt;</span> <span class="kw">INTERSECT</span></a>
<a class="sourceLine" id="cb1-4" title="4">    csc343h<span class="op">-</span>prof<span class="op">-&gt;</span> (<span class="kw">SELECT</span> sid <span class="kw">FROM</span> Took <span class="kw">WHERE</span> grade <span class="op">&lt;</span> <span class="dv">50</span>);</a>
<a class="sourceLine" id="cb1-5" title="5">      sid  </a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="co">-------</span></a>
<a class="sourceLine" id="cb1-7" title="7">     <span class="dv">99132</span></a>
<a class="sourceLine" id="cb1-8" title="8">       <span class="dv">157</span></a>
<a class="sourceLine" id="cb1-9" title="9">    (<span class="dv">2</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>In fact, all set operations (<code>INTERSECT</code>, <code>UNION</code> and <code>EXCEPT</code>) have two subqueries as operands.</p>
<h2 id="subquery-in-a-from-clause">Subquery in a FROM clause</h2>
<p>A subquery can take the place of a table name in the <code>FROM</code> clause of a query. For example, this query reports which students have taken which course offerings:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb2-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, dept<span class="op">||</span>cNum <span class="kw">as</span> course</a>
<a class="sourceLine" id="cb2-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Took, </a>
<a class="sourceLine" id="cb2-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>      Offering      <span class="co">-- This piece is about to change.</span></a>
<a class="sourceLine" id="cb2-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> Took.<span class="kw">oID</span> <span class="op">=</span> Offering.<span class="kw">oID</span>;</a>
<a class="sourceLine" id="cb2-5" title="5">      sid  | course </a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="co">-------+--------</span></a>
<a class="sourceLine" id="cb2-7" title="7">       <span class="dv">157</span> | CSC343</a>
<a class="sourceLine" id="cb2-8" title="8">     <span class="dv">99999</span> | CSC343</a>
<a class="sourceLine" id="cb2-9" title="9">     <span class="dv">98000</span> | CSC343</a>
<a class="sourceLine" id="cb2-10" title="10">     <span class="dv">99132</span> | CSC343</a>
<a class="sourceLine" id="cb2-11" title="11">       <span class="dv">157</span> | CSC343</a>
<a class="sourceLine" id="cb2-12" title="12">     <span class="dv">99132</span> | CSC207</a>
<a class="sourceLine" id="cb2-13" title="13">       <span class="dv">157</span> | CSC207</a>
<a class="sourceLine" id="cb2-14" title="14">     etc.</a></code></pre></div>
<p>Suppose we want to restrict the query to consider just course offerings where the instructor was Horton. We can achieve that by replacing table <code>Offering</code> with a more specific subquery:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb3-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">SELECT</span> sID, dept<span class="op">||</span>cNum <span class="kw">as</span> course</a>
<a class="sourceLine" id="cb3-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Took, </a>
<a class="sourceLine" id="cb3-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>      (<span class="kw">SELECT</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb3-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>       <span class="kw">FROM</span> Offering </a>
<a class="sourceLine" id="cb3-5" title="5">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>       <span class="kw">WHERE</span> instructor <span class="op">=</span> <span class="st">&#39;Horton&#39;</span></a>
<a class="sourceLine" id="cb3-6" title="6">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>      ) Hoffering</a>
<a class="sourceLine" id="cb3-7" title="7">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> Took.<span class="kw">oID</span> <span class="op">=</span> Hoffering.<span class="kw">oID</span>;</a></code></pre></div>
<p>There are two syntactic requirements for subqueries in a <code>FROM</code> clause:</p>
<ul>
<li>The subquery must be enclosed in round brackets.</li>
<li>We must name the result of the subquery; this allows us to refer to it elsewhere.</li>
</ul>
<p>In this case, we named the subquery result <code>Hoffering</code> (for “Horton offering”). In the <code>WHERE</code> clause, notice that we compared to <code>Hoffering.oID</code>. If we compared instead to <code>Offering.oid</code>, we would get an error. We can’t talk about that table in our <code>WHERE</code> clause because we never brought it in to the conversation in the <code>FROM</code> clause. The error message would report: <code>missing FROM-clause entry for table "offering"</code>.</p>
<p>Notice that we didn’t need to use a subquery; we could just as easily have done the filtering for Horton’s course offerings in the <code>WHERE</code> clause:</p>
<pre class="sq:"><code>    csc343h-dianeh=&gt; SELECT sID, dept||cNum as course
    csc343h-dianeh-&gt; FROM Took, Offering
    csc343h-dianeh-&gt; WHERE Took.oID = Offering.oID AND
    csc343h-dianeh-&gt; instructor = &#39;Horton&#39;;</code></pre>
<p>This is a simpler query to understand, which also means we are less likely to make a mistake writing it. What about efficiency? If we were to naively compute the results in the manner suggested by the query, we would produce a huge Cartesian product, including many, many rows about other instructors, that would be pruned by the <code>WHERE</code> clause. It is more efficient to do what the subquery version suggests, and eliminate all the non-Horton offerings before blowing things up into a huge Cartesian product.</p>
<p>But remember: any DBMS will be will do query optimization rather than implement the query naively. In fact, in postgreSQL, we can easily see the DBMS’s plan for executing a query using the <code>EXPLAIN</code> command. Here is its plan for the more “efficient” version of the query:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb5-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">EXPLAIN</span></a>
<a class="sourceLine" id="cb5-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">SELECT</span> sID, dept<span class="op">||</span>cNum <span class="kw">as</span> course</a>
<a class="sourceLine" id="cb5-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Took, </a>
<a class="sourceLine" id="cb5-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>      (<span class="kw">SELECT</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb5-5" title="5">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>       <span class="kw">FROM</span> Offering </a>
<a class="sourceLine" id="cb5-6" title="6">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>       <span class="kw">WHERE</span> instructor <span class="op">=</span> <span class="st">&#39;Horton&#39;</span></a>
<a class="sourceLine" id="cb5-7" title="7">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>      ) Hoffering</a>
<a class="sourceLine" id="cb5-8" title="8">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> Took.<span class="kw">oID</span> <span class="op">=</span> Hoffering.<span class="kw">oID</span>;</a>
<a class="sourceLine" id="cb5-9" title="9">                                  <span class="kw">QUERY</span> <span class="kw">PLAN</span>                              </a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="co">----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb5-11" title="11">     <span class="kw">Hash</span> <span class="kw">Join</span>  (<span class="kw">cost</span><span class="op">=</span><span class="dv">19</span>.<span class="dv">05</span><span class="op">..</span><span class="fl">20.81</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">1</span> width<span class="op">=</span><span class="dv">40</span>)</a>
<a class="sourceLine" id="cb5-12" title="12">       <span class="kw">Hash</span> Cond: (took.<span class="kw">oid</span> <span class="op">=</span> offering.<span class="kw">oid</span>)</a>
<a class="sourceLine" id="cb5-13" title="13">       <span class="op">-&gt;</span>  Seq <span class="kw">Scan</span> <span class="kw">on</span> took  (<span class="kw">cost</span><span class="op">=</span><span class="dv">0</span>.<span class="dv">00</span><span class="op">..</span><span class="fl">1.54</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">54</span> width<span class="op">=</span><span class="dv">8</span>)</a>
<a class="sourceLine" id="cb5-14" title="14">       <span class="op">-&gt;</span>  <span class="kw">Hash</span>  (<span class="kw">cost</span><span class="op">=</span><span class="dv">19</span>.<span class="dv">00</span><span class="op">..</span><span class="fl">19.00</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">4</span> width<span class="op">=</span><span class="dv">40</span>)</a>
<a class="sourceLine" id="cb5-15" title="15">             <span class="op">-&gt;</span>  Seq <span class="kw">Scan</span> <span class="kw">on</span> offering  (<span class="kw">cost</span><span class="op">=</span><span class="dv">0</span>.<span class="dv">00</span><span class="op">..</span><span class="fl">19.00</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">4</span> width<span class="op">=</span><span class="dv">40</span>)</a>
<a class="sourceLine" id="cb5-16" title="16">                   <span class="kw">Filter</span>: ((instructor):<span class="ch">:text</span> <span class="op">=</span> <span class="st">&#39;Horton&#39;</span>:<span class="ch">:text</span>)</a>
<a class="sourceLine" id="cb5-17" title="17">    (<span class="dv">6</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>The details of the query plan are a little beyond what we’ve learned so far (although notice the mention of hashing; pay attention when you learning hashing in csc263 – it’s useful as well a conceptually interesting!). But notice that both the total cost and all the details of the plan are <em>exactly the same</em> as in the query plan for the simpler but “inefficient” version of the query:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb6-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">explain</span> <span class="kw">SELECT</span> sID, dept<span class="op">||</span>cNum <span class="kw">as</span> course</a>
<a class="sourceLine" id="cb6-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Took, Offering</a>
<a class="sourceLine" id="cb6-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> Took.<span class="kw">oID</span> <span class="op">=</span> Offering.<span class="kw">oID</span> <span class="kw">AND</span></a>
<a class="sourceLine" id="cb6-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> instructor <span class="op">=</span> <span class="st">&#39;Horton&#39;</span>;</a>
<a class="sourceLine" id="cb6-5" title="5">                                  <span class="kw">QUERY</span> <span class="kw">PLAN</span>                              </a>
<a class="sourceLine" id="cb6-6" title="6">    <span class="co">----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb6-7" title="7">     <span class="kw">Hash</span> <span class="kw">Join</span>  (<span class="kw">cost</span><span class="op">=</span><span class="dv">19</span>.<span class="dv">05</span><span class="op">..</span><span class="fl">20.81</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">1</span> width<span class="op">=</span><span class="dv">40</span>)</a>
<a class="sourceLine" id="cb6-8" title="8">       <span class="kw">Hash</span> Cond: (took.<span class="kw">oid</span> <span class="op">=</span> offering.<span class="kw">oid</span>)</a>
<a class="sourceLine" id="cb6-9" title="9">       <span class="op">-&gt;</span>  Seq <span class="kw">Scan</span> <span class="kw">on</span> took  (<span class="kw">cost</span><span class="op">=</span><span class="dv">0</span>.<span class="dv">00</span><span class="op">..</span><span class="fl">1.54</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">54</span> width<span class="op">=</span><span class="dv">8</span>)</a>
<a class="sourceLine" id="cb6-10" title="10">       <span class="op">-&gt;</span>  <span class="kw">Hash</span>  (<span class="kw">cost</span><span class="op">=</span><span class="dv">19</span>.<span class="dv">00</span><span class="op">..</span><span class="fl">19.00</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">4</span> width<span class="op">=</span><span class="dv">40</span>)</a>
<a class="sourceLine" id="cb6-11" title="11">             <span class="op">-&gt;</span>  Seq <span class="kw">Scan</span> <span class="kw">on</span> offering  (<span class="kw">cost</span><span class="op">=</span><span class="dv">0</span>.<span class="dv">00</span><span class="op">..</span><span class="fl">19.00</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">4</span> width<span class="op">=</span><span class="dv">40</span>)</a>
<a class="sourceLine" id="cb6-12" title="12">                   <span class="kw">Filter</span>: ((instructor):<span class="ch">:text</span> <span class="op">=</span> <span class="st">&#39;Horton&#39;</span>:<span class="ch">:text</span>)</a>
<a class="sourceLine" id="cb6-13" title="13">    (<span class="dv">6</span> <span class="kw">rows</span>)</a></code></pre></div>
<h2 id="subquery-as-a-value-in-a-where-clause">Subquery as a value in a WHERE clause</h2>
<p>If a subquery produces exactly one row, we can compare to it in a <code>WHERE</code> clause. Here’s an example:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb7-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, surname, cgpa</a>
<a class="sourceLine" id="cb7-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb7-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> cgpa <span class="op">&gt;</span></a>
<a class="sourceLine" id="cb7-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>    (<span class="kw">SELECT</span> cgpa</a>
<a class="sourceLine" id="cb7-5" title="5">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb7-6" title="6">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">WHERE</span> sID <span class="op">=</span> <span class="dv">99999</span>);</a>
<a class="sourceLine" id="cb7-7" title="7">      sid  |  surname   | cgpa </a>
<a class="sourceLine" id="cb7-8" title="8">    <span class="co">-------+------------+------</span></a>
<a class="sourceLine" id="cb7-9" title="9">     <span class="dv">99132</span> | Marchmount | <span class="fl">3.13</span></a>
<a class="sourceLine" id="cb7-10" title="10">     <span class="dv">98000</span> | Fairgrieve | <span class="fl">4.00</span></a>
<a class="sourceLine" id="cb7-11" title="11">       <span class="dv">157</span> | Lakemeyer  | <span class="fl">3.42</span></a>
<a class="sourceLine" id="cb7-12" title="12">    (<span class="dv">3</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>Since <code>sID</code> is the primary key of the <code>Student</code> table, the subquery <em>cannot</em> produce more than one row.</p>
<p>If we check the result of the subquery, we see that the above query does produce students with higher CGPAs than this one:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb8-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> cgpa</a>
<a class="sourceLine" id="cb8-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb8-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> sID <span class="op">=</span> <span class="dv">99999</span>;</a>
<a class="sourceLine" id="cb8-4" title="4">     cgpa </a>
<a class="sourceLine" id="cb8-5" title="5">    <span class="co">------</span></a>
<a class="sourceLine" id="cb8-6" title="6">     <span class="fl">2.98</span></a>
<a class="sourceLine" id="cb8-7" title="7">    (<span class="dv">1</span> <span class="kw">row</span>)</a></code></pre></div>
<p>Note that this is the first kind of subquery that we can’t do equivalently in relational algebra. (Think about it.)</p>
<p>There are two special cases to consider when using a subquery in a <code>WHERE</code> clause. First, what will happen if the subquery returns an empty table? For example, if we use an sID that doesn’t exist in the table:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb9-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="co">-- Confirming that there is no student with this sID.</span></a>
<a class="sourceLine" id="cb9-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> cgpa</a>
<a class="sourceLine" id="cb9-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb9-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> sID <span class="op">=</span> <span class="op">-</span><span class="dv">44</span>;</a>
<a class="sourceLine" id="cb9-5" title="5">     cgpa </a>
<a class="sourceLine" id="cb9-6" title="6">    <span class="co">------</span></a>
<a class="sourceLine" id="cb9-7" title="7">    (<span class="dv">0</span> <span class="kw">rows</span>)</a>
<a class="sourceLine" id="cb9-8" title="8">    </a>
<a class="sourceLine" id="cb9-9" title="9">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="co">-- Now let&#39;s see what the full query does.</span></a>
<a class="sourceLine" id="cb9-10" title="10">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, surname, cgpa</a>
<a class="sourceLine" id="cb9-11" title="11">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb9-12" title="12">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> cgpa <span class="op">&gt;</span></a>
<a class="sourceLine" id="cb9-13" title="13">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>    (<span class="kw">SELECT</span> cgpa</a>
<a class="sourceLine" id="cb9-14" title="14">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb9-15" title="15">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">WHERE</span> sID <span class="op">=</span> <span class="op">-</span><span class="dv">44</span>);</a>
<a class="sourceLine" id="cb9-16" title="16">     sid | surname | cgpa </a>
<a class="sourceLine" id="cb9-17" title="17">    <span class="co">-----+---------+------</span></a>
<a class="sourceLine" id="cb9-18" title="18">    (<span class="dv">0</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>No CGPA can be greater than one that doesn’t exist, so this query, appropriately, produces an empty table.</p>
<p>The second special case is a subquery that produces more than one row.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb10-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="co">-- Here&#39;s a subquery with more than one row.</span></a>
<a class="sourceLine" id="cb10-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> cgpa</a>
<a class="sourceLine" id="cb10-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb10-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> campus <span class="op">=</span> <span class="st">&#39;StG&#39;</span>;</a>
<a class="sourceLine" id="cb10-5" title="5">     cgpa </a>
<a class="sourceLine" id="cb10-6" title="6">    <span class="co">------</span></a>
<a class="sourceLine" id="cb10-7" title="7">     <span class="fl">3.13</span></a>
<a class="sourceLine" id="cb10-8" title="8">     <span class="fl">4.00</span></a>
<a class="sourceLine" id="cb10-9" title="9">     <span class="fl">0.40</span></a>
<a class="sourceLine" id="cb10-10" title="10">    (<span class="dv">3</span> <span class="kw">rows</span>)</a>
<a class="sourceLine" id="cb10-11" title="11">    </a>
<a class="sourceLine" id="cb10-12" title="12">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="co">-- Now let&#39;s see what the full query does.</span></a>
<a class="sourceLine" id="cb10-13" title="13">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, surname, cgpa</a>
<a class="sourceLine" id="cb10-14" title="14">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb10-15" title="15">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> cgpa <span class="op">&gt;</span></a>
<a class="sourceLine" id="cb10-16" title="16">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>    (<span class="kw">SELECT</span> cgpa</a>
<a class="sourceLine" id="cb10-17" title="17">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb10-18" title="18">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">WHERE</span> campus <span class="op">=</span> <span class="st">&#39;StG&#39;</span>);    </a>
<a class="sourceLine" id="cb10-19" title="19">    ERROR:  more <span class="kw">than</span> one <span class="kw">row</span> returned <span class="kw">by</span> a subquery used <span class="kw">as</span> an expression</a></code></pre></div>
<p>The DBMS refuses to compare each individual CGPA to the three that are returned by the subquery. So when we use a subquery in this way, we must be sure that it will return either 0 rows or 1 row.</p>
<h2 id="quantifying-over-multiple-results">Quantifying over multiple results</h2>
<p>In fact, there <em>is</em> a way to compare an individual value to all those returned by the subquery. We just have to tell SQL what quantifier to use!</p>
<h3 id="all-universal-quantification">ALL (universal quantification)</h3>
<p>If we want the comparison to hold <strong>for all</strong> values in the subquery, we use the keyword <code>ALL</code>. For example, if we want to find students with a CGPA greater than all CGPAs on the St George campus, we would write:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb11-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, surname, cgpa</a>
<a class="sourceLine" id="cb11-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb11-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> cgpa <span class="op">&gt;</span> <span class="kw">ALL</span>      <span class="co">-- Here we add the keyword ALL</span></a>
<a class="sourceLine" id="cb11-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>    (<span class="kw">SELECT</span> cgpa</a>
<a class="sourceLine" id="cb11-5" title="5">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb11-6" title="6">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">WHERE</span> campus <span class="op">=</span> <span class="st">&#39;StG&#39;</span>);</a>
<a class="sourceLine" id="cb11-7" title="7">     sid | surname | cgpa </a>
<a class="sourceLine" id="cb11-8" title="8">    <span class="co">-----+---------+------</span></a>
<a class="sourceLine" id="cb11-9" title="9">    (<span class="dv">0</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>The query is now legal, but returns no one. What happened? In our little database, this is the whole <code>Student</code> table:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb12-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> Student;</a>
<a class="sourceLine" id="cb12-2" title="2">      sid  | firstname |  surname   | campus |   email   | cgpa </a>
<a class="sourceLine" id="cb12-3" title="3">    <span class="co">-------+-----------+------------+--------+-----------+------</span></a>
<a class="sourceLine" id="cb12-4" title="4">     <span class="dv">99132</span> | Avery     | Marchmount | StG    | avery@cs  | <span class="fl">3.13</span></a>
<a class="sourceLine" id="cb12-5" title="5">     <span class="dv">98000</span> | William   | Fairgrieve | StG    | will@cs   | <span class="fl">3.90</span></a>
<a class="sourceLine" id="cb12-6" title="6">     <span class="dv">99999</span> | Afsaneh   | Ali        | UTSC   | aali@cs   | <span class="fl">2.98</span></a>
<a class="sourceLine" id="cb12-7" title="7">       <span class="dv">157</span> | Leilani   | Lakemeyer  | UTM    | lani@cs   | <span class="fl">3.42</span></a>
<a class="sourceLine" id="cb12-8" title="8">     <span class="dv">11111</span> | Homer     | Simpson    | StG    | doh@gmail | <span class="fl">0.40</span></a>
<a class="sourceLine" id="cb12-9" title="9">    (<span class="dv">5</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>No one has a CGPA that beats every single St George student. But what about William? His CGPA is higher than everyone else’s, so it’s certainly higher than everyone else’s on the St George campus. Yet he doesn’t appear in the result. Why not? It is because his CGPA is not higher than <em>his own</em>. Remember that we compared to <em>all</em> CGPAs of St George students.</p>
<p>If we change the comparison operator to <code>&gt;=</code>, William appears in the answer:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb13-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, surname, cgpa</a>
<a class="sourceLine" id="cb13-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb13-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> cgpa <span class="op">&gt;=</span> <span class="kw">ALL</span>      <span class="co">-- Now we change comparisons to &gt;=</span></a>
<a class="sourceLine" id="cb13-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>    (<span class="kw">SELECT</span> cgpa</a>
<a class="sourceLine" id="cb13-5" title="5">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb13-6" title="6">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">WHERE</span> campus <span class="op">=</span> <span class="st">&#39;StG&#39;</span>);</a>
<a class="sourceLine" id="cb13-7" title="7">      sid  |  surname   | cgpa </a>
<a class="sourceLine" id="cb13-8" title="8">    <span class="co">-------+------------+------</span></a>
<a class="sourceLine" id="cb13-9" title="9">     <span class="dv">98000</span> | Fairgrieve | <span class="fl">3.90</span></a>
<a class="sourceLine" id="cb13-10" title="10">    (<span class="dv">1</span> <span class="kw">row</span>)</a></code></pre></div>
<h3 id="some-existential-quantification">SOME (existential quantification)</h3>
<p>If we want the comparison to hold <strong>for at least one</strong> value in the subquery, we use the keyword <code>SOME</code>. For example, if we want to find students with a CGPA greater than at least one CGPA on the St George campus, we would write:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb14-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, surname, cgpa</a>
<a class="sourceLine" id="cb14-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb14-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> cgpa <span class="op">&gt;</span> <span class="kw">SOME</span>      <span class="co">-- Familiar query, but with SOME.</span></a>
<a class="sourceLine" id="cb14-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>    (<span class="kw">SELECT</span> cgpa</a>
<a class="sourceLine" id="cb14-5" title="5">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb14-6" title="6">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">WHERE</span> campus <span class="op">=</span> <span class="st">&#39;StG&#39;</span>);</a>
<a class="sourceLine" id="cb14-7" title="7">      sid  |  surname   | cgpa </a>
<a class="sourceLine" id="cb14-8" title="8">    <span class="co">-------+------------+------</span></a>
<a class="sourceLine" id="cb14-9" title="9">     <span class="dv">99132</span> | Marchmount | <span class="fl">3.13</span></a>
<a class="sourceLine" id="cb14-10" title="10">     <span class="dv">98000</span> | Fairgrieve | <span class="fl">3.90</span></a>
<a class="sourceLine" id="cb14-11" title="11">     <span class="dv">99999</span> | Ali        | <span class="fl">2.98</span></a>
<a class="sourceLine" id="cb14-12" title="12">       <span class="dv">157</span> | Lakemeyer  | <span class="fl">3.42</span></a>
<a class="sourceLine" id="cb14-13" title="13">    (<span class="dv">4</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>This reports every student except Homer Simpson. He is the only student whose CGPA does not beat anyone on the St George campus.</p>
<!-- 
Could make this a PCRS multiple-choice question:
Specify exactly what student(s) will be excluded in the result of this query.
(a) The student with the lowest CGPA overall (all of them if there is a tie).
(b) The student with the lowest CGPA on St George campus (all of them if there is a tie).
(c) Every student with a CGPA lower than at least one student on St George campus.
etc.
-->
<p>The keyword <code>SOME</code> has a synonym in SQL: <code>ANY</code>. We would get exactly the same result if we switched to <code>ANY</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb15-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, surname, cgpa</a>
<a class="sourceLine" id="cb15-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb15-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> cgpa <span class="op">&gt;</span> <span class="kw">ANY</span>      <span class="co">-- ANY is a synonym for SOME.</span></a>
<a class="sourceLine" id="cb15-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>    (<span class="kw">SELECT</span> cgpa</a>
<a class="sourceLine" id="cb15-5" title="5">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb15-6" title="6">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">WHERE</span> campus <span class="op">=</span> <span class="st">&#39;StG&#39;</span>);</a>
<a class="sourceLine" id="cb15-7" title="7">      sid  |  surname   | cgpa </a>
<a class="sourceLine" id="cb15-8" title="8">    <span class="co">-------+------------+------</span></a>
<a class="sourceLine" id="cb15-9" title="9">     <span class="dv">99132</span> | Marchmount | <span class="fl">3.13</span></a>
<a class="sourceLine" id="cb15-10" title="10">     <span class="dv">98000</span> | Fairgrieve | <span class="fl">3.90</span></a>
<a class="sourceLine" id="cb15-11" title="11">     <span class="dv">99999</span> | Ali        | <span class="fl">2.98</span></a>
<a class="sourceLine" id="cb15-12" title="12">       <span class="dv">157</span> | Lakemeyer  | <span class="fl">3.42</span></a>
<a class="sourceLine" id="cb15-13" title="13">    (<span class="dv">4</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>But beware of using <code>ANY</code>. When you read a query with <code>ANY</code> in it, it can mislead you into thinking that it’s a universal quantifier. For example, you might easily paraphrase the above query as “Find students whose CGPA is higher than any other CGPA” (which is what it sounds like). In other words, find the student with the highest CGPA. This is completely wrong. We recommend always choosing to use <code>SOME</code> instead of <code>ANY</code>. In this example, the paraphrase “Find students whose CGPA is higher than <em>some</em> other CGPA” would be fine.</p>
<h3 id="in-and-not-in">IN and NOT IN</h3>
<p>Sometimes the comparison we want to make to the result of a subquery is very simple: we just want to know whether or not a particular value occurs in it. Although we could accomplish this using <code>SOME</code> and <code>ANY</code> as we’ll soon see, SQL provides <code>IN</code> and <code>NOT IN</code> for convenience.</p>
<p>Here’s a simple example:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb16-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="co">-- Find results for students who&#39;ve taken a course</span></a>
<a class="sourceLine" id="cb16-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="co">-- taught by Atwood.</span></a>
<a class="sourceLine" id="cb16-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, dept<span class="op">||</span>cnum <span class="kw">AS</span> course, grade</a>
<a class="sourceLine" id="cb16-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Took <span class="kw">JOIN</span> Offering <span class="kw">USING</span> (<span class="kw">oID</span>)</a>
<a class="sourceLine" id="cb16-5" title="5">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> <span class="kw">oID</span> <span class="kw">IN</span> (</a>
<a class="sourceLine" id="cb16-6" title="6">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>     <span class="kw">SELECT</span> <span class="kw">oID</span></a>
<a class="sourceLine" id="cb16-7" title="7">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>     <span class="kw">FROM</span> Offering</a>
<a class="sourceLine" id="cb16-8" title="8">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>     <span class="kw">WHERE</span> instructor <span class="op">=</span> <span class="st">&#39;Atwood&#39;</span></a>
<a class="sourceLine" id="cb16-9" title="9">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span> );</a>
<a class="sourceLine" id="cb16-10" title="10">      sid  | course | grade </a>
<a class="sourceLine" id="cb16-11" title="11">    <span class="co">-------+--------+-------</span></a>
<a class="sourceLine" id="cb16-12" title="12">     <span class="dv">99132</span> | ENG110 |    <span class="dv">98</span></a>
<a class="sourceLine" id="cb16-13" title="13">     <span class="dv">98000</span> | ENG110 |    <span class="dv">79</span></a>
<a class="sourceLine" id="cb16-14" title="14">     <span class="dv">99999</span> | ENG110 |   <span class="dv">100</span></a>
<a class="sourceLine" id="cb16-15" title="15">     <span class="dv">11111</span> | ENG110 |    <span class="dv">17</span></a>
<a class="sourceLine" id="cb16-16" title="16">    (<span class="dv">4</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>Notice that we could have done the same thing using <code>= SOME</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb17-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, dept<span class="op">||</span>cnum <span class="kw">AS</span> course, grade</a>
<a class="sourceLine" id="cb17-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Took <span class="kw">JOIN</span> Offering <span class="kw">USING</span> (<span class="kw">oID</span>)</a>
<a class="sourceLine" id="cb17-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> <span class="kw">oID</span> <span class="op">=</span> <span class="kw">SOME</span> (</a>
<a class="sourceLine" id="cb17-4" title="4">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>     <span class="kw">SELECT</span> <span class="kw">oID</span></a>
<a class="sourceLine" id="cb17-5" title="5">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>     <span class="kw">FROM</span> Offering</a>
<a class="sourceLine" id="cb17-6" title="6">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>     <span class="kw">WHERE</span> instructor <span class="op">=</span> <span class="st">&#39;Atwood&#39;</span></a>
<a class="sourceLine" id="cb17-7" title="7">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span> );</a>
<a class="sourceLine" id="cb17-8" title="8">      sid  | course | grade </a>
<a class="sourceLine" id="cb17-9" title="9">    <span class="co">-------+--------+-------</span></a>
<a class="sourceLine" id="cb17-10" title="10">     <span class="dv">99132</span> | ENG110 |    <span class="dv">98</span></a>
<a class="sourceLine" id="cb17-11" title="11">     <span class="dv">98000</span> | ENG110 |    <span class="dv">79</span></a>
<a class="sourceLine" id="cb17-12" title="12">     <span class="dv">99999</span> | ENG110 |   <span class="dv">100</span></a>
<a class="sourceLine" id="cb17-13" title="13">     <span class="dv">11111</span> | ENG110 |    <span class="dv">17</span></a>
<a class="sourceLine" id="cb17-14" title="14">    (<span class="dv">4</span> <span class="kw">rows</span>)</a></code></pre></div>
<!--
Harder IN-query on the slide, confirmed to be correct in psql:

csc343h-dianeh=> select sid, dept||cnum as course, grade
from took join offering using (oid)
where grade >= 80 and (cnum, dept) in
   (select cnum, dept
   from took join offering using (oid)
   join student using (sid)
   where surname = 'Lakemeyer');
-->
<p>So we don’t need to use <code>IN</code>. Similarly we don’t need to use <code>NOT IN</code>; it is equivalent to <code>&lt;&gt; ALL</code>. (Remember that <code>&lt;&gt;</code> means “not equal to”; postgreSQL also accepts <code>!=</code>.) So this query with <code>NOT IN</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb18-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, dept<span class="op">||</span>cnum <span class="kw">AS</span> course, grade</a>
<a class="sourceLine" id="cb18-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">FROM</span> Took <span class="kw">JOIN</span> Offering <span class="kw">USING</span> (<span class="kw">oID</span>)</a>
<a class="sourceLine" id="cb18-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">WHERE</span> <span class="kw">oID</span> <span class="kw">NOT</span> <span class="kw">IN</span> (</a>
<a class="sourceLine" id="cb18-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">SELECT</span> <span class="kw">oID</span></a>
<a class="sourceLine" id="cb18-5" title="5">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">FROM</span> Took</a>
<a class="sourceLine" id="cb18-6" title="6">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">oID</span></a>
<a class="sourceLine" id="cb18-7" title="7">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">HAVING</span> <span class="fu">avg</span>(grade) <span class="op">&gt;</span> <span class="dv">85</span>);</a>
<a class="sourceLine" id="cb18-8" title="8">      sid  | course | grade </a>
<a class="sourceLine" id="cb18-9" title="9">    <span class="co">-------+--------+-------</span></a>
<a class="sourceLine" id="cb18-10" title="10">       <span class="dv">157</span> | CSC343 |    <span class="dv">82</span></a>
<a class="sourceLine" id="cb18-11" title="11">       <span class="dv">157</span> | CSC207 |    <span class="dv">59</span></a>
<a class="sourceLine" id="cb18-12" title="12">     <span class="dv">99999</span> | CSC207 |    <span class="dv">76</span></a>
<a class="sourceLine" id="cb18-13" title="13">     <span class="dv">98000</span> | CSC207 |    <span class="dv">89</span></a>
<a class="sourceLine" id="cb18-14" title="14">     etc.</a></code></pre></div>
<p>is equivalent to this query with <code>&lt;&gt; ALL</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb19-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, dept<span class="op">||</span>cnum <span class="kw">AS</span> course, grade</a>
<a class="sourceLine" id="cb19-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">FROM</span> Took <span class="kw">JOIN</span> Offering <span class="kw">USING</span> (<span class="kw">oID</span>)</a>
<a class="sourceLine" id="cb19-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">WHERE</span> <span class="kw">oID</span> <span class="op">&lt;&gt;</span> <span class="kw">ALL</span> (</a>
<a class="sourceLine" id="cb19-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">SELECT</span> <span class="kw">oID</span></a>
<a class="sourceLine" id="cb19-5" title="5">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">FROM</span> Took</a>
<a class="sourceLine" id="cb19-6" title="6">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">oID</span></a>
<a class="sourceLine" id="cb19-7" title="7">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">HAVING</span> <span class="fu">avg</span>(grade) <span class="op">&gt;</span> <span class="dv">85</span>);</a>
<a class="sourceLine" id="cb19-8" title="8">      sid  | course | grade </a>
<a class="sourceLine" id="cb19-9" title="9">    <span class="co">-------+--------+-------</span></a>
<a class="sourceLine" id="cb19-10" title="10">       <span class="dv">157</span> | CSC343 |    <span class="dv">82</span></a>
<a class="sourceLine" id="cb19-11" title="11">       <span class="dv">157</span> | CSC207 |    <span class="dv">59</span></a>
<a class="sourceLine" id="cb19-12" title="12">     <span class="dv">99999</span> | CSC207 |    <span class="dv">76</span></a>
<a class="sourceLine" id="cb19-13" title="13">     <span class="dv">98000</span> | CSC207 |    <span class="dv">89</span></a>
<a class="sourceLine" id="cb19-14" title="14">     etc.</a></code></pre></div>
<p>When reading this query, the “<code>oID &lt;&gt; ALL</code>” can be hard to understand. What it means is that, for all values y in the subquery, the oID under consideration does not equal y.</p>
<h3 id="exists">EXISTS</h3>
<p>The final kind of quantification we can use does not involve any comparison. We use it in a <code>WHERE</code> clause when we don’t want to compare a value to all the results in a subquery, we just want to know whether or not there <em>are</em> any results in the subquery.</p>
<p>Here is an example with <code>EXISTS</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb20-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> instructor</a>
<a class="sourceLine" id="cb20-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">FROM</span> Offering</a>
<a class="sourceLine" id="cb20-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">WHERE</span> <span class="kw">EXISTS</span> (</a>
<a class="sourceLine" id="cb20-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">SELECT</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb20-5" title="5">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">FROM</span> TOOK</a>
<a class="sourceLine" id="cb20-6" title="6">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">WHERE</span> Took.<span class="kw">oID</span> <span class="op">=</span> Offering.<span class="kw">oID</span> <span class="kw">AND</span> grade <span class="op">&gt;</span> <span class="dv">98</span></a>
<a class="sourceLine" id="cb20-7" title="7">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> );</a>
<a class="sourceLine" id="cb20-8" title="8">     instructor </a>
<a class="sourceLine" id="cb20-9" title="9">    <span class="co">------------</span></a>
<a class="sourceLine" id="cb20-10" title="10">     Johancsik</a>
<a class="sourceLine" id="cb20-11" title="11">     Zorich</a>
<a class="sourceLine" id="cb20-12" title="12">     Horton</a>
<a class="sourceLine" id="cb20-13" title="13">     Atwood</a>
<a class="sourceLine" id="cb20-14" title="14">    (<span class="dv">4</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>As the <code>WHERE</code> clause considers each row of the <code>Offering</code> table, we don’t compare its attributes to anything. We just check whether or not the subquery can find any rows in <code>Took</code> that are for that offering ID and with a very high grade. Notice that the subquery refers to the <code>Offering</code> table in the outer query; it uses the oID of the particular row from <code>Offering</code> that is under consideration. Every time we consider a new row, there is a new offering ID, so the subquery must be recomputed. We call this a <strong>correlated subquery</strong>.</p>
<p>Each subquery we saw previously was an <strong>uncorrelated subquery</strong>. For example:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb21-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> sID, surname, cgpa</a>
<a class="sourceLine" id="cb21-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb21-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span> <span class="kw">WHERE</span> cgpa <span class="op">&gt;</span></a>
<a class="sourceLine" id="cb21-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">-&gt;</span>    (<span class="kw">SELECT</span> cgpa</a>
<a class="sourceLine" id="cb21-5" title="5">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">FROM</span> Student</a>
<a class="sourceLine" id="cb21-6" title="6">    csc343h<span class="op">-</span>dianeh(<span class="op">&gt;</span>    <span class="kw">WHERE</span> sID <span class="op">=</span> <span class="dv">99999</span>);</a></code></pre></div>
<p>Here the subquery makes no reference at all to do with the outer query. This means that it can be computed once and reused over and over for each row of <code>Student</code> that is assessed by the <code>WHERE</code> clause.</p>
<p>Returning to <code>EXISTS</code>, students often wonder why we use it. For instance, the query above for finding instructors who have given a grade over 98 could be written without <code>EXISTS</code>. (Try it!) But the <code>EXISTS</code> version of the query is faster, because it can stop as soon as it finds a tuple that satisfies the subquery.</p>
<p>Here is a trickier <code>EXISTS</code> query:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb22-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> instructor</a>
<a class="sourceLine" id="cb22-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">FROM</span> Offering O1</a>
<a class="sourceLine" id="cb22-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">WHERE</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> (</a>
<a class="sourceLine" id="cb22-4" title="4">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">SELECT</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb22-5" title="5">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">FROM</span> Offering O2</a>
<a class="sourceLine" id="cb22-6" title="6">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>    <span class="kw">WHERE</span> O2.<span class="kw">oID</span> <span class="op">&lt;&gt;</span> O1.<span class="kw">oID</span> <span class="kw">AND</span></a>
<a class="sourceLine" id="cb22-7" title="7">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span>          O2.instructor <span class="op">=</span> O1.instructor </a>
<a class="sourceLine" id="cb22-8" title="8">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> );</a>
<a class="sourceLine" id="cb22-9" title="9">     instructor </a>
<a class="sourceLine" id="cb22-10" title="10">    <span class="co">------------</span></a>
<a class="sourceLine" id="cb22-11" title="11">     Truta</a>
<a class="sourceLine" id="cb22-12" title="12">     <span class="kw">Heap</span></a>
<a class="sourceLine" id="cb22-13" title="13">     Chechik</a>
<a class="sourceLine" id="cb22-14" title="14">     Davies</a>
<a class="sourceLine" id="cb22-15" title="15">     Johancsik</a>
<a class="sourceLine" id="cb22-16" title="16">     Reisman</a>
<a class="sourceLine" id="cb22-17" title="17">     Dow</a>
<a class="sourceLine" id="cb22-18" title="18">     Miller</a>
<a class="sourceLine" id="cb22-19" title="19">     Mendel</a>
<a class="sourceLine" id="cb22-20" title="20">     Richler</a>
<a class="sourceLine" id="cb22-21" title="21">    (<span class="dv">10</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>Notice that the inner and outer queries each introduce table <code>Offering</code>. We give aliases (<code>O1</code> and <code>O2</code>) to both of them for clarity, although it would have been sufficient just to give an alias to one of them.</p>
<p>Think about what the query does. For each course offering <code>O1</code>, the correlated subquery must be re-computed, with that <code>O1</code> held constant. Can you specify exactly what the query computes? It may help you to see the rows of <code>Offering</code> involving one of the professors who does appear in the query result:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb23-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> </a>
<a class="sourceLine" id="cb23-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">FROM</span> Offering</a>
<a class="sourceLine" id="cb23-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">WHERE</span> instructor <span class="op">=</span> <span class="st">&#39;Truta&#39;</span>;</a>
<a class="sourceLine" id="cb23-4" title="4">     <span class="kw">oid</span> | cnum | dept | term  | instructor </a>
<a class="sourceLine" id="cb23-5" title="5">    <span class="co">-----+------+------+-------+------------</span></a>
<a class="sourceLine" id="cb23-6" title="6">       <span class="dv">2</span> |  <span class="dv">343</span> | CSC  | <span class="dv">20089</span> | Truta</a>
<a class="sourceLine" id="cb23-7" title="7">    (<span class="dv">1</span> <span class="kw">row</span>)</a></code></pre></div>
<p>and the rows for one professor who does not:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb24-1" title="1">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> </a>
<a class="sourceLine" id="cb24-2" title="2">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">FROM</span> Offering</a>
<a class="sourceLine" id="cb24-3" title="3">    csc343h<span class="op">-</span>dianeh<span class="op">=&gt;</span> <span class="kw">WHERE</span> instructor <span class="op">=</span> <span class="st">&#39;Suzuki&#39;</span>;</a>
<a class="sourceLine" id="cb24-4" title="4">     <span class="kw">oid</span> | cnum | dept | term  | instructor </a>
<a class="sourceLine" id="cb24-5" title="5">    <span class="co">-----+------+------+-------+------------</span></a>
<a class="sourceLine" id="cb24-6" title="6">      <span class="dv">17</span> |  <span class="dv">320</span> | ENV  | <span class="dv">20089</span> | Suzuki</a>
<a class="sourceLine" id="cb24-7" title="7">      <span class="dv">32</span> |  <span class="dv">216</span> | EEB  | <span class="dv">20081</span> | Suzuki</a>
<a class="sourceLine" id="cb24-8" title="8">      <span class="dv">33</span> |  <span class="dv">263</span> | EEB  | <span class="dv">20081</span> | Suzuki</a>
<a class="sourceLine" id="cb24-9" title="9">      <span class="dv">36</span> |  <span class="dv">200</span> | ENV  | <span class="dv">20081</span> | Suzuki</a>
<a class="sourceLine" id="cb24-10" title="10">    (<span class="dv">4</span> <span class="kw">rows</span>)</a></code></pre></div>
<h3 id="summary">Summary</h3>
<p>This summary of the various quantifiers is a useful reference:</p>
<p><img src="./images/quantifiers.jpg" alt="Summary of quantifiers and their meaning" width="400"/></p>
</section>
</body>
</html>
